import uproot
import numpy as np
import matplotlib.pyplot as plt
import awkward as ak
import os

# Functions
def FWHM2sigma(FWHM):
    """Convert FWHM to standard deviation."""
    return FWHM / (2 * np.sqrt(2 * np.log(2)))

# CONSTANTS
SOURCE_ENERGIES_KEV = [200, 2000, 10000]
ORIENTATIONS = [0, 90, 180]

TREE_KEYS = ["SToGS;1", "SToGS;2"]

BIN_MAP = { # used for histogram displays
    200:  np.linspace(0, 0.2, 500),
    2000: np.linspace(0, 2, 500),
    10000: np.linspace(0, 11, 500),
}

fig, ax = plt.subplots(len(SOURCE_ENERGIES_KEV), len(ORIENTATIONS))
fig.subplots_adjust(hspace=0.4)


# DATA
for orient_idx, orientation in enumerate(ORIENTATIONS):
    for row_idx, energy_kev in enumerate(SOURCE_ENERGIES_KEV): # one plot (two detectors) per iteration

        # FILE NAMING DEFINITION
        filename = f"two_tubes//two_{orientation}_{energy_kev}.root"
        print(f"Processing file: {filename}...")

        if not os.path.exists(filename):
            print(f"WARNING: File not found: {filename}. Skipping this energy.")
            continue
        
        for tree_key in TREE_KEYS:

            # part that is acrually doing something
            with uproot.open(filename) as file:
                tree = file[tree_key]

                EvH = tree["Ev.H"].array()  # energies of hits
                Evnb = tree["Ev.nb"].array()  # number of hits per event
            
            
            # Flatten all hits across all events
            E_hits = EvH

            # --- Compute FWHM and sigma for each hit ---
            FWHM_percent = 77.11212 * (E_hits*1000)**(-0.5)
            FWHM_abs = FWHM_percent / 100 * E_hits
            sigma_hits = FWHM2sigma(FWHM_abs)

            # --- Apply Gaussian smearing to each hit ---
            E_smeared = np.random.normal(E_hits, sigma_hits)

                      
        


        bins = np.linspace(0.01, energy_kev/1000, 500)
        # Plotting the histograms
        ax[row_idx,orient_idx].hist(E_hits, bins=bins, color='red', label="nierozmyte", histtype='step')
        ax[row_idx,orient_idx].hist(E_smeared, bins=bins, color='green', label="rozmyte", histtype='step')
        ax[row_idx,orient_idx].set_title(f"{energy_kev / 1000} MeV, Relative orientation: {orientation}, Smear and no smear", fontsize=10)
        ax[row_idx,orient_idx].grid(True, alpha=0.5)
        ax[row_idx,orient_idx].set_ylabel("Counts")
        ax[row_idx,orient_idx].set_xlabel("Energy [MeV]")   
        ax[row_idx,orient_idx].legend()   
        ax[row_idx,orient_idx].set_yscale('log')  
        


fig.suptitle(f"Coincidence", fontsize=14, y=0.98)
print("Processing done, witing for plots...")
# --- 5. Final Display ---

plt.show()














